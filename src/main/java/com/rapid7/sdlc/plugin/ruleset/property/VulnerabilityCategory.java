package com.rapid7.sdlc.plugin.ruleset.property;

import com.rapid7.sdlc.plugin.api.model.Image;
import com.rapid7.sdlc.plugin.api.model.Package;
import com.rapid7.sdlc.plugin.ruleset.CriterionName;
import com.rapid7.sdlc.plugin.ruleset.RuleResult;
import java.util.List;
import java.util.Set;
import static java.util.stream.Collectors.toList;
import static java.util.stream.Collectors.toSet;

/**
 * A property that is satisfied if any package has a vulnerability whose category is
 * substring-matched by the given pattern.
 */
public class VulnerabilityCategory extends StringContainsPropertyEvaluator {

  public static final String displayName = "Vulnerability category contains";

  public VulnerabilityCategory() {

  }

  public VulnerabilityCategory(String pattern) {
    super(pattern);
  }

  @Override
  public String getDisplayName() {
    return displayName;
  }

  @Override
  public RuleResult check(Image result) {
    return new RuleResult(result.getPackages().stream()
        .anyMatch(pkg -> pkg.getAssessment().getFindings().stream()
            .anyMatch(finding -> finding.getVulnerability().getCategories().stream()
                .anyMatch(cat -> cat.toLowerCase().contains(pattern.toLowerCase())))),
        pattern);
  }

  @Override
  public Set<Package> getQualifyingPackages(Image image) {
    return image.getPackages().stream().filter(pkg -> pkg.getAssessment().getFindings().stream()
            .anyMatch(finding -> finding.getVulnerability().getCategories().stream()
                .anyMatch(cat -> cat.toLowerCase().contains(pattern.toLowerCase()))))
        .collect(toSet());
  }

  @Override
  public String getCriterionName() {
    return CriterionName.VULN_CATEGORY.name();
  }

  @Override
  public List<String> getMatches(Image image) {
    return image.getPackages().stream().map(Package::getAssessment)
        .flatMap(assessment -> assessment.getFindings().stream()
            .flatMap(finding -> finding.getVulnerability().getCategories().stream().filter(c -> c.toLowerCase().contains(pattern.toLowerCase()))))
        .collect(toList());
  }
}
